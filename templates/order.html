<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Arrange Document Order</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem auto;
        max-width: 720px;
        color: #1f2933;
      }
      h1 {
        color: #0b7285;
      }
      .container {
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        padding: 1.5rem;
        background: #f8fafc;
      }
      .team-summary {
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        padding: 1rem;
        background: #fff;
        margin-bottom: 1.5rem;
      }
      .team-summary h2 {
        margin: 0 0 0.5rem 0;
        font-size: 1.1rem;
      }
      .team-summary p {
        margin-top: 0;
        margin-bottom: 0.75rem;
      }
      .team-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin: 0;
        padding: 0;
        list-style: none;
      }
      .team-pill {
        border: 1px solid #0b7285;
        background: #e3fafc;
        color: #0b7285;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        cursor: pointer;
        font-size: 0.9rem;
      }
      .team-pill:hover {
        background: #c5f6fa;
      }
      .team-pill.ungrouped {
        border-color: #495057;
        color: #495057;
        background: #f1f3f5;
      }
      select {
        width: 100%;
        min-height: 260px;
        font-size: 1rem;
      }
      .controls {
        margin-top: 1rem;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      button {
        background-color: #0b7285;
        border: none;
        color: white;
        padding: 0.6rem 1.2rem;
        font-size: 1rem;
        border-radius: 4px;
        cursor: pointer;
      }
      button.secondary {
        background: #495057;
      }
      button:hover {
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <h1>Arrange the document order</h1>
    <p>
      Use the controls below to choose the order of the Word documents. The selected order
      will be saved and used as the default the next time you upload a report.
    </p>

    {% if team_summaries %}
      <div class="team-summary">
        <h2>Detected teams</h2>
        <p>Select a team to jump to the first document. Use the team controls below to adjust their order.</p>
        <div class="team-list">
          {% for summary in team_summaries %}
            <button
              type="button"
              class="team-pill{% if not summary.name %} ungrouped{% endif %}"
              onclick="focusTeam({{ (summary.name if summary.name else '__ungrouped__') | tojson }})"
            >
              {{ summary.name if summary.name else 'Ungrouped' }} Â· {{ summary.count }}
            </button>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <div class="container">
      <form action="{{ url_for('start_processing') }}" method="post" id="order-form">
        <input type="hidden" name="job_id" value="{{ job_id }}" />
        <input type="hidden" name="email" value="{{ email }}" />
        <input type="hidden" name="order" id="order-input" />

        <label for="file-order">Document order</label>
        <select id="file-order" size="10" multiple>
          {% for name in ordered_display_names %}
            {% set entry = entry_map[name] %}
            <option value="{{ name }}" data-team="{{ entry.team_name or '' }}" selected>
              {{ name }}
            </option>
          {% endfor %}
        </select>

        <div class="controls">
          <button type="button" class="secondary" onclick="move(-1)">Move up</button>
          <button type="button" class="secondary" onclick="move(1)">Move down</button>
          {% if has_teams %}
            <button type="button" class="secondary" onclick="moveTeamBy(-1)">Move team up</button>
            <button type="button" class="secondary" onclick="moveTeamBy(1)">Move team down</button>
          {% endif %}
          <button type="button" class="secondary" onclick="resetToOriginal()">Reset order</button>
          <button type="submit">Start background processing</button>
        </div>
      </form>
    </div>

    <script>
      const select = document.getElementById("file-order");
      const orderInput = document.getElementById("order-input");
      const form = document.getElementById("order-form");
      const initialOrder = Array.from(select.options).map((option) => option.value);

      function move(direction) {
        const selectedIndex = select.selectedIndex;
        if (selectedIndex < 0) {
          return;
        }
        const newIndex = selectedIndex + direction;
        if (newIndex < 0 || newIndex >= select.options.length) {
          return;
        }

        const options = Array.from(select.options);
        const [moved] = options.splice(selectedIndex, 1);
        options.splice(newIndex, 0, moved);

        setOptions(options);
        select.selectedIndex = newIndex;
      }

      function setOptions(options) {
        const fragment = document.createDocumentFragment();
        for (const option of options) {
          fragment.appendChild(option);
        }
        select.innerHTML = "";
        select.appendChild(fragment);
      }

      function resetToOriginal() {
        const optionByValue = new Map(Array.from(select.options).map((option) => [option.value, option]));
        const ordered = initialOrder.map((value) => optionByValue.get(value)).filter(Boolean);
        setOptions(ordered);
        if (ordered.length) {
          select.selectedIndex = 0;
        }
      }

      function moveTeamBy(direction) {
        const selectedOption = select.options[select.selectedIndex];
        if (!selectedOption) {
          return;
        }

        const selectedTeam = selectedOption.dataset.team || "";
        const options = Array.from(select.options);
        const teamOrder = [];
        const teamOptionsMap = new Map();

        for (const option of options) {
          const team = option.dataset.team || "";
          if (!teamOptionsMap.has(team)) {
            teamOptionsMap.set(team, []);
            teamOrder.push(team);
          }
          teamOptionsMap.get(team).push(option);
        }

        const currentIndex = teamOrder.indexOf(selectedTeam);
        if (currentIndex < 0) {
          return;
        }

        const newIndex = currentIndex + direction;
        if (newIndex < 0 || newIndex >= teamOrder.length) {
          return;
        }

        const [team] = teamOrder.splice(currentIndex, 1);
        teamOrder.splice(newIndex, 0, team);

        const ordered = teamOrder.flatMap((teamName) => teamOptionsMap.get(teamName) || []);
        setOptions(ordered);

        const selectedTeamOptions = teamOptionsMap.get(selectedTeam) || [];
        const firstValue = selectedTeamOptions.length ? selectedTeamOptions[0].value : null;
        if (!firstValue) {
          return;
        }

        const nextIndex = ordered.findIndex((option) => option.value === firstValue);
        if (nextIndex >= 0) {
          select.selectedIndex = nextIndex;
          select.focus();
        }
      }

      function focusTeam(teamName) {
        const options = Array.from(select.options);
        const normalisedTeam = teamName === "__ungrouped__" ? "" : teamName;
        const targetIndex = options.findIndex((option) => (option.dataset.team || "") === normalisedTeam);
        if (targetIndex >= 0) {
          select.selectedIndex = targetIndex;
          select.focus();
        }
      }

      function updateOrderInput() {
        const values = Array.from(select.options).map((option) => option.value);
        orderInput.value = values.join("|");
      }

      form.addEventListener("submit", (event) => {
        updateOrderInput();
        if (!orderInput.value) {
          event.preventDefault();
          alert("Please select at least one document.");
        }
      });
    </script>
  </body>
</html>
