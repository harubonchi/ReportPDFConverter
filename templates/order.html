<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Arrange Document Order</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem auto;
        max-width: 720px;
        color: #1f2933;
      }
      h1 {
        color: #0b7285;
      }
      .container {
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        padding: 1.5rem;
        background: #f8fafc;
      }
      .team-summary {
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        padding: 1rem;
        background: #fff;
        margin-bottom: 1.5rem;
      }
      .team-summary h2 {
        margin: 0 0 0.5rem 0;
        font-size: 1.1rem;
      }
      .team-summary p {
        margin-top: 0;
        margin-bottom: 0.75rem;
      }
      .team-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin: 0;
        padding: 0;
        list-style: none;
      }
      .team-pill {
        border: 1px solid #0b7285;
        background: #e3fafc;
        color: #0b7285;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        cursor: grab;
        font-size: 0.9rem;
      }
      .team-pill:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(11, 114, 133, 0.2);
      }
      .team-pill:hover {
        background: #c5f6fa;
      }
      .team-pill.dragging {
        opacity: 0.6;
        cursor: grabbing;
      }
      .team-pill.ungrouped {
        border-color: #495057;
        color: #495057;
        background: #f1f3f5;
      }
      .document-board {
        border: 1px dashed #94a3b8;
        border-radius: 8px;
        background: #fff;
        padding: 0.75rem;
        max-height: 420px;
        overflow-y: auto;
        margin-top: 0.75rem;
      }
      .document-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .document-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        padding: 0.65rem 0.9rem;
        background: #fdfdfd;
        cursor: grab;
      }
      .document-item:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(11, 114, 133, 0.25);
      }
      .document-item.dragging {
        opacity: 0.6;
        cursor: grabbing;
      }
      .document-item.is-selected {
        border-color: #0b7285;
        box-shadow: 0 0 0 2px rgba(11, 114, 133, 0.3);
      }
      .doc-title {
        font-weight: 600;
        margin-right: 1rem;
      }
      .team-badge {
        background: #e3fafc;
        color: #0b7285;
        border-radius: 999px;
        padding: 0.25rem 0.65rem;
        font-size: 0.75rem;
        font-weight: 600;
        white-space: nowrap;
      }
      .team-badge.ungrouped {
        background: #f1f3f5;
        color: #495057;
      }
      .list-hint {
        font-size: 0.9rem;
        color: #495057;
        margin-top: 0.35rem;
      }
      .controls {
        margin-top: 1rem;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      button {
        background-color: #0b7285;
        border: none;
        color: white;
        padding: 0.6rem 1.2rem;
        font-size: 1rem;
        border-radius: 4px;
        cursor: pointer;
      }
      button.secondary {
        background: #495057;
      }
      button:hover {
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <h1>Arrange the document order</h1>
    <p>
      Use the controls below to choose the order of the Word documents. The selected order
      will be saved and used as the default the next time you upload a report.
    </p>

    {% if team_summaries %}
      <div class="team-summary">
        <h2>Detected teams</h2>
        <p>Click a team to jump to its first document. Drag the chips to reorder the team blocks.</p>
        <div class="team-list">
          {% for summary in team_summaries %}
            <button
              type="button"
              class="team-pill{% if not summary.name %} ungrouped{% endif %}"
              data-team="{{ summary.name if summary.name else '' }}"
              data-key="{{ summary.name if summary.name else '__ungrouped__' }}"
              draggable="true"
            >
              {{ summary.name if summary.name else 'Ungrouped' }} Â· {{ summary.count }}
            </button>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <div class="container">
      <form action="{{ url_for('start_processing') }}" method="post" id="order-form">
        <input type="hidden" name="job_id" value="{{ job_id }}" />
        <input type="hidden" name="email" value="{{ email }}" />
        <input type="hidden" name="order" id="order-input" />

        <label for="document-list">Document order</label>
        <p class="list-hint">Drag and drop the documents to arrange them in the desired order.</p>
        <div class="document-board">
          <ul id="document-list" class="document-list">
            {% for name in ordered_display_names %}
              {% set entry = entry_map[name] %}
              <li
                class="document-item"
                draggable="true"
                data-name="{{ name }}"
                data-team="{{ entry.team_name or '' }}"
                tabindex="0"
              >
                <span class="doc-title">{{ name }}</span>
                <span class="team-badge{% if not entry.team_name %} ungrouped{% endif %}">
                  {{ entry.team_name if entry.team_name else 'Ungrouped' }}
                </span>
              </li>
            {% endfor %}
          </ul>
        </div>

        <div class="controls">
          <button type="button" class="secondary" id="reset-button">Reset order</button>
          <button type="submit">Start background processing</button>
        </div>
      </form>
    </div>

    <script type="application/json" id="initial-order-data">{{ ordered_display_names | tojson }}</script>
    <script type="application/json" id="initial-team-order">{{ team_order_keys | tojson }}</script>

    <script>
      const documentList = document.getElementById("document-list");
      const orderInput = document.getElementById("order-input");
      const form = document.getElementById("order-form");
      const resetButton = document.getElementById("reset-button");
      const initialOrderElement = document.getElementById("initial-order-data");
      const initialOrder = initialOrderElement ? JSON.parse(initialOrderElement.textContent) : [];
      const initialTeamOrderElement = document.getElementById("initial-team-order");
      const initialTeamOrder = initialTeamOrderElement ? JSON.parse(initialTeamOrderElement.textContent) : [];
      const teamContainer = document.querySelector(".team-list");
      const teamKeyToActual = new Map();

      if (teamContainer) {
        Array.from(teamContainer.querySelectorAll(".team-pill")).forEach((pill) => {
          teamKeyToActual.set(pill.dataset.key, pill.dataset.team || "");
        });
      }
      teamKeyToActual.set("__ungrouped__", "");

      let draggedItem = null;
      let draggingTeamPill = null;
      let selectedItem = null;

      function updateOrderInput() {
        const values = Array.from(documentList.querySelectorAll(".document-item")).map((item) => item.dataset.name);
        orderInput.value = values.join("|");
      }

      function clearSelection() {
        if (selectedItem) {
          selectedItem.classList.remove("is-selected");
          selectedItem = null;
        }
      }

      function setSelectedItem(item) {
        if (selectedItem === item) {
          return;
        }
        clearSelection();
        selectedItem = item;
        if (selectedItem) {
          selectedItem.classList.add("is-selected");
        }
      }

      function focusTeam(teamKey) {
        const actualTeam = teamKey === "__ungrouped__" ? "" : teamKeyToActual.get(teamKey) ?? teamKey;
        const target = Array.from(documentList.querySelectorAll(".document-item")).find(
          (item) => (item.dataset.team || "") === actualTeam,
        );
        if (target) {
          setSelectedItem(target);
          target.scrollIntoView({ behavior: "smooth", block: "center" });
          if (typeof target.focus === "function") {
            try {
              target.focus({ preventScroll: true });
            } catch (error) {
              target.focus();
            }
          }
        }
      }

      function reorderDocumentsByTeam(teamKeys) {
        if (!teamKeys.length) {
          updateOrderInput();
          return;
        }
        const grouped = new Map();
        const items = Array.from(documentList.querySelectorAll(".document-item"));
        items.forEach((item) => {
          const team = item.dataset.team || "";
          if (!grouped.has(team)) {
            grouped.set(team, []);
          }
          grouped.get(team).push(item);
        });

        const orderedItems = [];
        teamKeys.forEach((key) => {
          const actualTeam = key === "__ungrouped__" ? "" : teamKeyToActual.get(key) ?? key;
          const groupItems = grouped.get(actualTeam) || [];
          orderedItems.push(...groupItems);
          grouped.delete(actualTeam);
        });

        grouped.forEach((groupItems) => {
          orderedItems.push(...groupItems);
        });

        documentList.replaceChildren(...orderedItems);
        updateOrderInput();
      }

      function resetTeamChips() {
        if (!teamContainer || !initialTeamOrder.length) {
          return;
        }
        const pillMap = new Map();
        Array.from(teamContainer.querySelectorAll(".team-pill")).forEach((pill) => {
          pillMap.set(pill.dataset.key, pill);
        });
        const ordered = [];
        initialTeamOrder.forEach((key) => {
          const pill = pillMap.get(key);
          if (pill) {
            ordered.push(pill);
            pillMap.delete(key);
          }
        });
        ordered.push(...pillMap.values());
        teamContainer.replaceChildren(...ordered);
      }

      function resetToOriginal() {
        const itemMap = new Map();
        Array.from(documentList.querySelectorAll(".document-item")).forEach((item) => {
          itemMap.set(item.dataset.name, item);
        });
        const orderedItems = [];
        initialOrder.forEach((name) => {
          const item = itemMap.get(name);
          if (item) {
            orderedItems.push(item);
            itemMap.delete(name);
          }
        });
        orderedItems.push(...itemMap.values());
        documentList.replaceChildren(...orderedItems);
        clearSelection();
        resetTeamChips();
        updateOrderInput();
      }

      documentList.addEventListener("dragstart", (event) => {
        const item = event.target.closest(".document-item");
        if (!item) {
          return;
        }
        draggedItem = item;
        item.classList.add("dragging");
        setSelectedItem(item);
        event.dataTransfer.effectAllowed = "move";
        event.dataTransfer.setData("text/plain", item.dataset.name);
      });

      documentList.addEventListener("dragover", (event) => {
        if (!draggedItem) {
          return;
        }
        event.preventDefault();
        const target = event.target.closest(".document-item");
        if (!target) {
          const rect = documentList.getBoundingClientRect();
          const shouldAppend = event.clientY - rect.top > rect.height / 2;
          if (shouldAppend) {
            documentList.appendChild(draggedItem);
          } else if (documentList.firstElementChild) {
            documentList.insertBefore(draggedItem, documentList.firstElementChild);
          }
          return;
        }
        if (target === draggedItem) {
          return;
        }
        const rect = target.getBoundingClientRect();
        const shouldInsertBefore = event.clientY - rect.top < rect.height / 2;
        documentList.insertBefore(draggedItem, shouldInsertBefore ? target : target.nextElementSibling);
      });

      documentList.addEventListener("drop", (event) => {
        if (draggedItem) {
          event.preventDefault();
        }
      });

      documentList.addEventListener("dragend", () => {
        if (!draggedItem) {
          return;
        }
        draggedItem.classList.remove("dragging");
        draggedItem = null;
        updateOrderInput();
      });

      documentList.addEventListener("click", (event) => {
        const item = event.target.closest(".document-item");
        if (item) {
          setSelectedItem(item);
        }
      });

      documentList.addEventListener("keydown", (event) => {
        const item = event.target.closest(".document-item");
        if (!item) {
          return;
        }
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          setSelectedItem(item);
        }
      });

      if (teamContainer) {
        teamContainer.addEventListener("click", (event) => {
          const pill = event.target.closest(".team-pill");
          if (!pill) {
            return;
          }
          focusTeam(pill.dataset.key);
        });

        teamContainer.addEventListener("keydown", (event) => {
          const pill = event.target.closest(".team-pill");
          if (!pill) {
            return;
          }
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            focusTeam(pill.dataset.key);
          }
        });

        teamContainer.addEventListener("dragstart", (event) => {
          const pill = event.target.closest(".team-pill");
          if (!pill) {
            return;
          }
          draggingTeamPill = pill;
          pill.classList.add("dragging");
          event.dataTransfer.effectAllowed = "move";
          event.dataTransfer.setData("text/plain", pill.dataset.key);
        });

        teamContainer.addEventListener("dragover", (event) => {
          if (!draggingTeamPill) {
            return;
          }
          event.preventDefault();
          const pill = event.target.closest(".team-pill");
          if (!pill || pill === draggingTeamPill) {
            return;
          }
          const rect = pill.getBoundingClientRect();
          const shouldInsertBefore = event.clientX - rect.left < rect.width / 2;
          teamContainer.insertBefore(draggingTeamPill, shouldInsertBefore ? pill : pill.nextElementSibling);
        });

        teamContainer.addEventListener("drop", (event) => {
          if (draggingTeamPill) {
            event.preventDefault();
          }
        });

        teamContainer.addEventListener("dragend", () => {
          if (!draggingTeamPill) {
            return;
          }
          draggingTeamPill.classList.remove("dragging");
          draggingTeamPill = null;
          const teamKeys = Array.from(teamContainer.querySelectorAll(".team-pill")).map((pill) => pill.dataset.key);
          reorderDocumentsByTeam(teamKeys);
        });
      }

      resetButton.addEventListener("click", () => {
        resetToOriginal();
      });

      form.addEventListener("submit", (event) => {
        updateOrderInput();
        if (!orderInput.value) {
          event.preventDefault();
          alert("Please select at least one document.");
        }
      });

      updateOrderInput();
      window.focusTeam = focusTeam;
    </script>
  </body>
</html>
