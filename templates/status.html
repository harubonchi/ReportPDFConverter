<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>ロボ研報告書作成ツール - 進行状況</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem auto;
        max-width: 720px;
        color: #1f2933;
      }
      .credit {
        position: fixed;
        top: 0.75rem;
        right: 1rem;
        font-size: 0.75rem;
        color: #64748b;
        opacity: 0.85;
      }
      h1 {
        color: #0b7285;
      }
      .status-box {
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        padding: 1.5rem;
        background: #f8fafc;
      }
      .status-value {
        font-size: 1.2rem;
        font-weight: bold;
      }
      .status-message {
        margin-top: 0.5rem;
        font-style: italic;
      }
      .progress-wrapper {
        margin-top: 1.25rem;
      }
      .progress-track {
        width: 100%;
        height: 12px;
        background: #e2e8f0;
        border-radius: 999px;
        overflow: hidden;
      }
      .progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #0b7285, #38bdf8);
        transition: width 0.3s ease;
      }
      .progress-text {
        margin-top: 0.5rem;
        font-size: 0.95rem;
        color: #0f172a;
        font-weight: 600;
      }
      .completed {
        color: #2b8a3e;
      }
      .failed {
        color: #c92a2a;
      }
      .elapsed-time {
        margin-top: 1rem;
        font-weight: 600;
        color: #0b7285;
      }
      .email-template {
        margin-top: 2rem;
        border: 1px solid #cbd5e1;
        border-radius: 10px;
        background: #f1f5f9;
        padding: 1.5rem;
      }
      .email-template h2 {
        margin-top: 0;
        color: #0b7285;
      }
      .email-description {
        margin: 0 0 1rem 0;
        color: #334155;
        font-size: 0.95rem;
      }
      .template-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      .template-controls label {
        display: flex;
        flex-direction: column;
        font-weight: 600;
        color: #1f2937;
        font-size: 0.95rem;
      }
      .template-controls select,
      .template-controls input {
        margin-top: 0.35rem;
        padding: 0.5rem 0.6rem;
        border-radius: 6px;
        border: 1px solid #cbd5e1;
        font-size: 1rem;
      }
      #email-template-text {
        width: 100%;
        min-height: 8rem;
        padding: 0.75rem;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        font-size: 1rem;
        font-family: "Hiragino Sans", "Noto Sans JP", Arial, sans-serif;
        background: #fff;
        resize: vertical;
        box-sizing: border-box;
      }
      #copy-template {
        margin-top: 0.75rem;
        background: #0b7285;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 0.6rem 1.25rem;
        font-size: 0.95rem;
        cursor: pointer;
      }
      #copy-template:hover {
        opacity: 0.92;
      }
      .copy-feedback {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #2b8a3e;
      }
      @media (max-width: 640px) {
        .template-controls {
          flex-direction: column;
        }
        .template-controls label {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="credit">制作者：石井遥紀 (2026年 修士卒業生)</div>
    <h1>処理状況</h1>
    <p>
      ジョブIDは <strong>{{ job_id }}</strong> です。<br>
      処理が完了するまで数秒おきに自動更新されます。
    </p>

    <div class="status-box">
      <div id="status" class="status-value">読み込み中…</div>
      <div id="message" class="status-message"></div>
      <div id="timestamp"></div>
    </div>

    <div id="progress-wrapper" class="progress-wrapper" hidden>
      <div
        id="progress-track"
        class="progress-track"
        role="progressbar"
        aria-valuemin="0"
        aria-valuemax="100"
        aria-valuenow="0"
      >
        <div id="progress-bar" class="progress-bar"></div>
      </div>
      <div id="progress-text" class="progress-text"></div>
    </div>

    <div id="elapsed-time" class="elapsed-time" hidden></div>

    <div id="email-template-section" class="email-template" hidden>
      <h2>先生にメールを送る場合の文章テンプレート</h2>
      <p class="email-description">班・学年・名前を設定すると文面が自動で更新されます。</p>
      <div class="template-controls">
        <label>
          班
          <select id="team-select">
            <option value="">（班を選択）</option>
          </select>
        </label>
        <label>
          学年
          <select id="grade-select">
            <option value="">（学年を選択）</option>
            <option value="B3">B3</option>
            <option value="B4">B4</option>
            <option value="M1">M1</option>
            <option value="M2">M2</option>
          </select>
        </label>
        <label>
          名前
          <input type="text" id="name-input" placeholder="氏名を入力" />
        </label>
      </div>
      <textarea id="email-template-text" rows="6" readonly></textarea>
      <button type="button" id="copy-template">テンプレートをコピー</button>
      <div id="copy-feedback" class="copy-feedback" role="status" aria-live="polite"></div>
    </div>

    <script>
      const statusUrl = "{{ url_for('job_status', job_id=job_id) }}";
      const statusLabels = {
        queued: "待機中",
        running: "処理中",
        completed: "完了",
        failed: "失敗",
      };
      const elapsedElement = document.getElementById("elapsed-time");
      const emailSection = document.getElementById("email-template-section");
      const teamSelect = document.getElementById("team-select");
      const gradeSelect = document.getElementById("grade-select");
      const nameInput = document.getElementById("name-input");
      const emailTextArea = document.getElementById("email-template-text");
      const copyButton = document.getElementById("copy-template");
      const copyFeedback = document.getElementById("copy-feedback");
      const progressWrapper = document.getElementById("progress-wrapper");
      const progressTrack = document.getElementById("progress-track");
      const progressBar = document.getElementById("progress-bar");
      const progressText = document.getElementById("progress-text");
      let teamOptionsInitialized = false;
      let currentReportNumber = "";

      function populateTeamOptions(options) {
        if (!teamSelect || teamOptionsInitialized) {
          return;
        }
        const uniqueOptions = Array.from(
          new Set(
            Array.isArray(options)
              ? options
                  .map((option) => (typeof option === "string" ? option.trim() : ""))
                  .filter((option) => option)
              : []
          )
        );
        teamSelect.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "（班を選択）";
        teamSelect.appendChild(placeholder);
        uniqueOptions.forEach((option) => {
          const element = document.createElement("option");
          element.value = option;
          element.textContent = option;
          teamSelect.appendChild(element);
        });
        teamSelect.value = "";
        teamOptionsInitialized = true;
      }

      function formatTeamLabel(value) {
        const trimmed = value.trim();
        if (!trimmed) {
          return "◯◯班";
        }
        if (trimmed === "班なし") {
          return trimmed;
        }
        return trimmed.endsWith("班") ? trimmed : `${trimmed}班`;
      }

      function updateEmailText() {
        if (!emailTextArea) {
          return;
        }
        if (!currentReportNumber) {
          emailTextArea.value = "";
          return;
        }
        const teamValue = teamSelect ? teamSelect.value || "" : "";
        const gradeValue = gradeSelect ? gradeSelect.value || "" : "";
        const nameValue = nameInput ? nameInput.value.trim() : "";
        const placeholderTeam = "◯◯班";
        const placeholderGrade = "(学年)";
        const placeholderName = "(名前)";
        const teamLabel = teamValue ? formatTeamLabel(teamValue) : placeholderTeam;
        const gradeLabel = gradeValue || placeholderGrade;
        const nameLabel = nameValue || placeholderName;
        const teamGradeSeparator = gradeValue ? (teamValue ? "" : " ") : " ";
        const gradeNameSeparator = nameValue ? "の" : " の ";
        emailTextArea.value = `お世話になっております。${teamLabel}${teamGradeSeparator}${gradeLabel}${gradeNameSeparator}${nameLabel}です。\n第${currentReportNumber}回報告書を添付しております。\nよろしくお願いいたします。`;
      }

      if (teamSelect) {
        teamSelect.addEventListener("change", updateEmailText);
      }
      if (gradeSelect) {
        gradeSelect.addEventListener("change", updateEmailText);
      }
      if (nameInput) {
        nameInput.addEventListener("input", updateEmailText);
      }
      if (copyButton) {
        copyButton.addEventListener("click", async () => {
          if (!emailTextArea || !emailTextArea.value) {
            return;
          }
          try {
            await navigator.clipboard.writeText(emailTextArea.value);
            if (copyFeedback) {
              copyFeedback.style.color = "#2b8a3e";
              copyFeedback.textContent = "テンプレートをコピーしました。";
            }
          } catch (error) {
            if (copyFeedback) {
              copyFeedback.textContent = "クリップボードへのコピーに失敗しました。";
              copyFeedback.style.color = "#c92a2a";
            }
          }
        });
      }

      async function refreshStatus() {
        try {
          const response = await fetch(statusUrl);
          if (!response.ok) {
            throw new Error("ステータスを取得できませんでした");
          }
          const data = await response.json();
          const statusElement = document.getElementById("status");
          const messageElement = document.getElementById("message");
          const timestampElement = document.getElementById("timestamp");

          statusElement.textContent = statusLabels[data.status] || data.status;
          statusElement.className = "status-value " + data.status;
          messageElement.textContent = data.message || "";
          timestampElement.textContent =
            "更新日時: " +
            new Date(data.updated_at).toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" });

          const totalStepsValue = Number(data.progress_total);
          const currentStepsValue = Number(data.progress_current);
          const hasTotal = Number.isFinite(totalStepsValue) && totalStepsValue > 0;
          const currentSteps = Number.isFinite(currentStepsValue)
            ? Math.max(0, currentStepsValue)
            : 0;
          const totalSteps = hasTotal ? totalStepsValue : 0;
          let percentValue =
            typeof data.progress_percent === "number" ? data.progress_percent : null;
          if (percentValue === null && totalSteps > 0) {
            percentValue = Math.round((currentSteps / totalSteps) * 100);
          }
          if (percentValue === null) {
            percentValue = 0;
          }
          const safePercent = Math.min(100, Math.max(0, percentValue));

          if (progressWrapper) {
            if (totalSteps > 0) {
              progressWrapper.hidden = false;
              if (progressBar) {
                progressBar.style.width = `${safePercent}%`;
              }
              if (progressTrack) {
                progressTrack.setAttribute("aria-valuenow", String(safePercent));
              }
              if (progressText) {
                progressText.textContent = `進捗: ${Math.min(currentSteps, totalSteps)}/${totalSteps} (${safePercent}%)`;
              }
            } else {
              progressWrapper.hidden = true;
              if (progressText) {
                progressText.textContent = "";
              }
            }
          }

          if (!teamOptionsInitialized && data.team_options) {
            populateTeamOptions(data.team_options);
          }

          if (data.status === "completed") {
            currentReportNumber = data.report_number || "";
            if (elapsedElement) {
              if (data.elapsed_display) {
                elapsedElement.textContent = `総経過時間: ${data.elapsed_display}`;
                elapsedElement.hidden = false;
              } else {
                elapsedElement.hidden = true;
              }
            }
            if (emailSection) {
              emailSection.hidden = false;
            }
            updateEmailText();
            return;
          }

          if (elapsedElement) {
            elapsedElement.hidden = true;
          }
          if (emailSection) {
            emailSection.hidden = true;
          }
          currentReportNumber = data.report_number || "";

          if (data.status === "completed" || data.status === "failed") {
            return;
          }
        } catch (error) {
          document.getElementById("status").textContent = "エラー";
          document.getElementById("message").textContent = error;
        }
        setTimeout(refreshStatus, 3000);
      }

      refreshStatus();
    </script>
  </body>
</html>