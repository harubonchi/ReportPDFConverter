<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="{{ url_for('static', filename='favicon.svg') }}"
    />
    <title>ロボ研報告書作成ツール - 進行状況</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem auto;
        max-width: 720px;
        color: #1f2933;
      }
      .credit {
        position: fixed;
        top: 0.75rem;
        right: 1rem;
        font-size: 0.75rem;
        color: #64748b;
        opacity: 0.85;
      }
      h1 {
        color: #0b7285;
      }
      .status-box {
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        padding: 1.25rem;
        background: #f8fafc;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .status-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
      }
      .status-main {
        display: flex;
        flex-direction: column;
        gap: 0.05rem;
        flex: 1 1 auto;
        min-width: 240px;
      }
      .status-main > * {
        margin: 0;
      }
      .status-value {
        font-size: 1.2rem;
        font-weight: bold;
      }
      .status-message {
        font-style: italic;
      }
      .status-meta {
        font-size: 0.95rem;
        color: #475569;
      }
      .conversion-section {
        margin-top: 1.75rem;
      }
      .conversion-section h2 {
        margin: 0 0 0.75rem 0;
        color: #0b7285;
        font-size: 1.25rem;
      }
      .conversion-grid {
        display: grid;
        gap: 0.75rem;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
      .conversion-item {
        background: #fff;
        border: 1px solid #cbd5e1;
        border-radius: 10px;
        padding: 0.85rem 1rem;
        box-shadow: 0 4px 14px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }
      .conversion-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 0.5rem;
        font-weight: 600;
        color: #0f172a;
      }
      .conversion-thread {
        background: #e0f2fe;
        color: #0369a1;
        border-radius: 999px;
        padding: 0.15rem 0.6rem;
        font-size: 0.8rem;
        white-space: nowrap;
      }
      .conversion-status {
        font-weight: 600;
        font-size: 0.95rem;
      }
      .conversion-status.queued {
        color: #475569;
      }
      .conversion-status.running {
        color: #0b7285;
      }
      .conversion-status.completed {
        color: #2b8a3e;
      }
      .conversion-status.failed {
        color: #c92a2a;
      }
      .completed {
        color: #2b8a3e;
      }
      .failed {
        color: #c92a2a;
      }
      .email-template {
        margin-top: 2rem;
        border: 1px solid #cbd5e1;
        border-radius: 10px;
        background: #f1f5f9;
        padding: 1.5rem;
      }
      .download-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #0b7285;
        color: #fff;
        text-decoration: none;
        padding: 0.8rem 1.9rem;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        box-shadow: 0 6px 16px rgba(15, 23, 42, 0.18);
        white-space: nowrap;
        width: auto;
        flex-shrink: 0;
      }
      .download-link:hover {
        opacity: 0.92;
      }
      .email-template h2 {
        margin-top: 0;
        color: #0b7285;
      }
      .email-description {
        margin: 0 0 1rem 0;
        color: #334155;
        font-size: 0.95rem;
      }
      .template-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      .template-controls label {
        display: flex;
        flex-direction: column;
        font-weight: 600;
        color: #1f2937;
        font-size: 0.95rem;
      }
      .template-controls select,
      .template-controls input {
        margin-top: 0.35rem;
        padding: 0.5rem 0.6rem;
        border-radius: 6px;
        border: 1px solid #cbd5e1;
        font-size: 1rem;
      }
      #email-template-text {
        width: 100%;
        min-height: 8rem;
        padding: 0.75rem;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        font-size: 1rem;
        font-family: "Hiragino Sans", "Noto Sans JP", Arial, sans-serif;
        background: #fff;
        resize: vertical;
        box-sizing: border-box;
      }
      #copy-template {
        margin-top: 0.75rem;
        background: #0b7285;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 0.6rem 1.25rem;
        font-size: 0.95rem;
        cursor: pointer;
      }
      #copy-template:hover {
        opacity: 0.92;
      }
      .copy-feedback {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #2b8a3e;
      }
      @media (max-width: 640px) {
        .template-controls {
          flex-direction: column;
        }
        .template-controls label {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="credit">制作者：石井遥紀 (2026年 修士卒業生)</div>
    <h1>処理状況</h1>
    <p>
      ジョブIDは <strong>{{ job_id }}</strong> です。<br>
      処理が完了するまで進捗が自動更新されます。
    </p>

    <div class="status-box">
      <div class="status-header">
        <div class="status-main">
          <div id="status" class="status-value">読み込み中…</div>
          <div id="message" class="status-message" hidden></div>
          <div id="timestamp" class="status-meta" hidden></div>
        </div>
        <a
          id="download-link"
          class="download-link"
          rel="noopener"
          download
          hidden
        ></a>
      </div>
    </div>

    <section id="conversion-section" class="conversion-section" hidden>
      <h2>ファイルごとの進捗</h2>
      <div id="conversion-grid" class="conversion-grid" role="list"></div>
    </section>

    <div id="email-template-section" class="email-template" hidden>
      <h2>先生にメールを送る時の文章テンプレート</h2>
      <p class="email-description">班・学年・名前を設定すると文面が自動で更新されます。</p>
      <div class="template-controls">
        <label>
          班
          <select id="team-select">
            <option value="">（班を選択）</option>
          </select>
        </label>
        <label>
          学年
          <select id="grade-select">
            <option value="">（学年を選択）</option>
            <option value="B3">B3</option>
            <option value="B4">B4</option>
            <option value="M1">M1</option>
            <option value="M2">M2</option>
          </select>
        </label>
        <label>
          名前
          <input type="text" id="name-input" placeholder="氏名を入力" />
        </label>
      </div>
      <textarea id="email-template-text" rows="6" readonly></textarea>
      <button type="button" id="copy-template">テンプレートをコピー</button>
      <div id="copy-feedback" class="copy-feedback" role="status" aria-live="polite"></div>
    </div>

    <script>
      const statusUrl = "{{ url_for('job_status', job_id=job_id) }}";
      const statusLabels = {
        queued: "待機中",
        running: "処理中",
        completed: "完了",
        failed: "失敗",
      };
      const emailSection = document.getElementById("email-template-section");
      const teamSelect = document.getElementById("team-select");
      const gradeSelect = document.getElementById("grade-select");
      const nameInput = document.getElementById("name-input");
      const emailTextArea = document.getElementById("email-template-text");
      const copyButton = document.getElementById("copy-template");
      const copyFeedback = document.getElementById("copy-feedback");
      const conversionSection = document.getElementById("conversion-section");
      const conversionGrid = document.getElementById("conversion-grid");
      const downloadLink = document.getElementById("download-link");
      if (downloadLink) {
        downloadLink.hidden = true;
        downloadLink.style.display = "none";
      }
      const conversionStatusLabels = {
        queued: "待機中",
        running: "処理中",
        completed: "完了",
        failed: "失敗",
      };
      let teamOptionsInitialized = false;
      let currentReportNumber = "";
      const downloadUrl = "{{ url_for('download_merged_pdf', job_id=job_id) }}";

      function populateTeamOptions(options) {
        if (!teamSelect || teamOptionsInitialized) {
          return;
        }
        const uniqueOptions = Array.from(
          new Set(
            Array.isArray(options)
              ? options
                  .map((option) => (typeof option === "string" ? option.trim() : ""))
                  .filter((option) => option)
              : []
          )
        );
        teamSelect.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "（班を選択）";
        teamSelect.appendChild(placeholder);
        uniqueOptions.forEach((option) => {
          const element = document.createElement("option");
          element.value = option;
          element.textContent = option;
          teamSelect.appendChild(element);
        });
        teamSelect.value = "";
        teamOptionsInitialized = true;
      }

      function formatTeamLabel(value) {
        const trimmed = value.trim();
        if (!trimmed) {
          return "◯◯班";
        }
        if (trimmed === "班なし") {
          return trimmed;
        }
        return trimmed.endsWith("班") ? trimmed : `${trimmed}班`;
      }

      function updateEmailText() {
        if (!emailTextArea) {
          return;
        }
        if (!currentReportNumber) {
          emailTextArea.value = "";
          return;
        }
        const teamValue = teamSelect ? teamSelect.value || "" : "";
        const gradeValue = gradeSelect ? gradeSelect.value || "" : "";
        const nameValue = nameInput ? nameInput.value.trim() : "";
        const placeholderTeam = "◯◯班";
        const placeholderGrade = "(学年)";
        const placeholderName = "(名前)";
        const teamLabel = teamValue ? formatTeamLabel(teamValue) : placeholderTeam;
        const gradeLabel = gradeValue || placeholderGrade;
        const nameLabel = nameValue || placeholderName;
        const teamGradeSeparator = gradeValue ? (teamValue ? "" : " ") : " ";
        const gradeNameSeparator = nameValue ? "の" : " の ";
        emailTextArea.value = `お世話になっております。${teamLabel}${teamGradeSeparator}${gradeLabel}${gradeNameSeparator}${nameLabel}です。\n第${currentReportNumber}回報告書を添付しております。\nよろしくお願いいたします。`;
      }

      if (teamSelect) {
        teamSelect.addEventListener("change", updateEmailText);
      }
      if (gradeSelect) {
        gradeSelect.addEventListener("change", updateEmailText);
      }
      if (nameInput) {
        nameInput.addEventListener("input", updateEmailText);
      }
      // クリップボードへのコピー（HTTPS以外やモバイルでも動くフォールバック付き）
      async function copyTextToClipboard(text) {
        // 優先: SecureContext での Clipboard API
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return true;
        }
        // フォールバック: 一時的な textarea を使った execCommand('copy')
        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          // 画面に見えないように配置
          ta.style.position = 'fixed';
          ta.style.top = '-1000px';
          ta.style.left = '-1000px';
          ta.setAttribute('readonly', '');
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          const ok = document.execCommand('copy');
          document.body.removeChild(ta);
          return ok;
        } catch (_) {
          return false;
        }
      }

      if (copyButton) {
        copyButton.addEventListener("click", async () => {
          if (!emailTextArea || !emailTextArea.value) {
            return;
          }
          const ok = await copyTextToClipboard(emailTextArea.value);
          if (ok) {
            if (copyFeedback) {
              copyFeedback.style.color = "#2b8a3e";
              copyFeedback.textContent = "テンプレートをコピーしました。";
            }
          } else {
            if (copyFeedback) {
              copyFeedback.textContent = "クリップボードへのコピーに失敗しました。";
              copyFeedback.style.color = "#c92a2a";
            }
          }
        });
      }

      function updateConversionProgress(entries, shouldShow) {
        if (!conversionSection || !conversionGrid) {
          return;
        }
        conversionGrid.innerHTML = "";
        if (!shouldShow) {
          conversionSection.hidden = true;
          return;
        }
        const items = Array.isArray(entries)
          ? entries.filter((entry) => entry && typeof entry === "object")
          : [];
        if (!items.length) {
          conversionSection.hidden = true;
          return;
        }
        const fragment = document.createDocumentFragment();
        items.forEach((entry) => {
          const displayName = typeof entry.display_name === "string"
            ? entry.display_name
            : "(ファイル名未取得)";
          const statusKey = typeof entry.status === "string"
            ? entry.status.toLowerCase()
            : "queued";
          const statusLabel = conversionStatusLabels[statusKey] || statusKey;
          const statusClass = ["queued", "running", "completed", "failed"].includes(statusKey)
            ? statusKey
            : "queued";
          const card = document.createElement("article");
          card.className = "conversion-item";
          card.setAttribute("role", "listitem");

          const header = document.createElement("div");
          header.className = "conversion-header";

          const nameSpan = document.createElement("span");
          nameSpan.textContent = displayName;
          header.appendChild(nameSpan);

          if (typeof entry.thread === "number" && entry.thread > 0) {
            const threadBadge = document.createElement("span");
            threadBadge.className = "conversion-thread";
            threadBadge.textContent = `スレッド${entry.thread}`;
            header.appendChild(threadBadge);
          }

          const statusSpan = document.createElement("span");
          statusSpan.className = `conversion-status ${statusClass}`;
          statusSpan.textContent = statusLabel;

          card.appendChild(header);
          card.appendChild(statusSpan);
          fragment.appendChild(card);
        });

        conversionGrid.appendChild(fragment);
        conversionSection.hidden = false;
      }

      let isRefreshing = false;
      let consecutiveNetworkErrors = 0;

      async function refreshStatus() {
        if (isRefreshing) {
          // 多重起動を避ける（積み上がり防止）
          return;
        }
        isRefreshing = true;
        // リクエストが応答しないまま固まるのを防ぐため、明示的なタイムアウトとキャッシュ無効化を行う
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000); // 3秒で中断
        // キャッシュを完全に避けるためクエリに時刻を付与し、fetch側も no-store を指定
        const url = `${statusUrl}?t=${Date.now()}`;
        try {
          const response = await fetch(url, { cache: "no-store", signal: controller.signal });
          if (!response.ok) {
            throw new Error("ステータスを取得できませんでした");
          }
          const data = await response.json();
          let shouldStopPolling = false;
          const statusElement = document.getElementById("status");
          const messageElement = document.getElementById("message");
          const timestampElement = document.getElementById("timestamp");
          const emailDeliveryStatusRaw =
            typeof data.email_delivery_status === "string"
              ? data.email_delivery_status.trim().toLowerCase()
              : "";

          statusElement.textContent = statusLabels[data.status] || data.status;
          statusElement.className = "status-value " + data.status;
          const messageText =
            typeof data.message === "string" ? data.message.trim() : "";
          if (messageElement) {
            if (messageText) {
              messageElement.textContent = messageText;
              messageElement.hidden = false;
            } else {
              messageElement.textContent = "";
              messageElement.hidden = true;
            }
          }

          let updatedAtText = "";
          if (data.updated_at) {
            updatedAtText =
              "更新日時: " +
              new Date(data.updated_at).toLocaleString("ja-JP", {
                timeZone: "Asia/Tokyo",
              });
          }
          let metaText = updatedAtText;

          const shouldShowConversion = Boolean(data.show_conversion_progress);
          updateConversionProgress(data.conversion_progress, shouldShowConversion);

          if (!teamOptionsInitialized && data.team_options) {
            populateTeamOptions(data.team_options);
          }

          if (data.status === "completed") {
            const reportNumberRaw =
              typeof data.report_number === "string" ? data.report_number.trim() : "";
            const shouldShowCompletionDetails = reportNumberRaw.length > 0;
            currentReportNumber = shouldShowCompletionDetails ? reportNumberRaw : "";
            if (downloadLink) {
              if (shouldShowCompletionDetails) {
                const fileName =
                  typeof data.final_pdf_name === "string" ? data.final_pdf_name.trim() : "";
                downloadLink.textContent = `第${currentReportNumber}回報告書をダウンロード`;
                downloadLink.href = `${downloadUrl}?t=${Date.now()}`;
                if (fileName) {
                  downloadLink.setAttribute("download", fileName);
                } else {
                  downloadLink.removeAttribute("download");
                }
                downloadLink.hidden = false;
                downloadLink.style.display = "inline-flex";
              } else {
                downloadLink.hidden = true;
                downloadLink.style.display = "none";
                downloadLink.textContent = "";
                downloadLink.removeAttribute("href");
                downloadLink.removeAttribute("download");
              }
            }
            if (emailSection) {
              emailSection.hidden = !shouldShowCompletionDetails;
            }
            if (shouldShowCompletionDetails) {
              updateEmailText();
              if (
                emailDeliveryStatusRaw === "sent" ||
                emailDeliveryStatusRaw === "failed" ||
                !emailDeliveryStatusRaw
              ) {
                shouldStopPolling = true;
              }
            } else if (emailTextArea) {
              emailTextArea.value = "";
            }
            if (data.elapsed_display) {
              metaText = `総経過時間: ${data.elapsed_display}`;
            }
          } else {
            if (downloadLink) {
              downloadLink.hidden = true;
              downloadLink.style.display = "none";
              downloadLink.textContent = "";
              downloadLink.removeAttribute("href");
              downloadLink.removeAttribute("download");
            }
            if (emailSection) {
              emailSection.hidden = true;
            }
            if (emailTextArea) {
              emailTextArea.value = "";
            }
            currentReportNumber = "";
          }

          if (timestampElement) {
            if (metaText) {
              timestampElement.textContent = metaText;
              timestampElement.hidden = false;
            } else {
              timestampElement.textContent = "";
              timestampElement.hidden = true;
            }
          }

          consecutiveNetworkErrors = 0; // 正常応答が返ればエラーカウンタをリセット
          if (shouldStopPolling || data.status === "failed") {
            return; // 意図的停止（完了/失敗）
          }
        } catch (error) {
          // AbortError は想定内（タイムアウト再試行）なのでユーザーに見せない
          if (error && (error.name === 'AbortError' || String(error).includes('AbortError'))) {
            // 何も表示しない（静かに再試行）
          } else {
            // ネットワーク不調等の場合は穏当なメッセージに留める
            consecutiveNetworkErrors += 1;
            const messageElement = document.getElementById("message");
            if (messageElement) {
              messageElement.textContent = "接続が不安定です。再試行中…";
              messageElement.hidden = false;
            }
          }
        } finally {
          clearTimeout(timeoutId);
          isRefreshing = false;
        }
        setTimeout(refreshStatus, 500); // 500ms間隔（0.5秒）に変更
      }

      refreshStatus();
    </script>
  </body>
</html>
